{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto px-6 py-12">

    <!-- Title -->
    <h1 class="text-3xl font-bold mb-6">Follow-up Assignment</h1>
    <p class="text-gray-600 mb-6">
        Weak topics identified from your previous attempt. Answer the following MCQs to improve your score.
    </p>

    <!-- Error Message -->
    {% if generation_error %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
        <strong class="font-semibold">‚ö†Ô∏è Unable to Generate Follow-ups:</strong>
        <p class="mt-1">{{ generation_error }}</p>
        <p class="mt-2 text-sm text-gray-600">
            This usually happens when the AI quota limit is reached or the model is temporarily overloaded.
        </p>
        <a href="{{ url_for('student.followup_assignment', attempt_id=attempt.id) }}"
           class="inline-block mt-3 px-4 py-2 bg-red-600 text-white text-sm font-medium rounded hover:bg-red-700">
            üîÅ Retry Now
        </a>
    </div>
    {% endif %}

    <!-- Follow-ups or Loading -->
    {% if weak_topics %}
        {% if followups %}
        <form method="POST" class="space-y-6">
            {% for fa in followups %}
            <div class="p-5 border rounded-lg shadow-sm hover:shadow-md transition bg-white">
                <p class="font-semibold mb-3">Q{{ loop.index }}: {{ fa.question_text }}</p>
                <div class="space-y-2">
                    {% for key, value in fa.options.items() %}
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="followup_{{ fa.id }}" value="{{ key }}"
                               {% if fa.student_answer == key %} checked {% endif %}
                               class="form-radio text-purple-600 focus:ring-purple-500">
                        <span>{{ key }}) {{ value }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}

            <button type="submit"
                    class="px-5 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition">
                ‚úÖ Submit Follow-up
            </button>
        </form>

        {% else %}
        <!-- Auto-refresh loader -->
        <div class="text-gray-500 text-center" id="loadingSection">
            <p>Follow-up assignments are being generated. Please wait...</p>
            <div class="mt-4 flex flex-col items-center justify-center space-y-2">
                <svg class="animate-spin h-8 w-8 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                     viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10"
                            stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                          d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
                <p id="refreshTimer" class="text-sm text-gray-400">Refreshing in 5 seconds...</p>
            </div>
        </div>

        <script>
            let countdown = 5;
            const timerDisplay = document.getElementById("refreshTimer");

            const timer = setInterval(() => {
                countdown--;
                timerDisplay.textContent = `Refreshing in ${countdown} seconds...`;
                if (countdown <= 0) {
                    clearInterval(timer);
                    window.location.reload();
                }
            }, 1000);
        </script>
        {% endif %}
    {% else %}
        <!-- No Weak Topics -->
        <div class="bg-green-50 border border-green-300 rounded-lg p-6 text-center">
            <h2 class="text-lg font-semibold text-green-700">üéâ No Weak Topics Found!</h2>
            <p class="text-gray-600 mt-2">
                Excellent work! You‚Äôve performed well in your last attempt ‚Äî no follow-up assignments needed.
            </p>
        </div>
    {% endif %}

    <!-- Score Display -->
    {% if attempt.followup_attempted %}
    <div class="mt-8 bg-purple-50 border border-purple-300 rounded-lg p-4 text-center">
        <p class="text-purple-700 font-semibold text-lg">
            ‚úÖ Your Improvement Score: {{ attempt.followup_score }}%
        </p>
    </div>
    {% endif %}

</div>
{% endblock %}
